<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dein persönlicher Assistent</title>
  <!-- Inter Font von Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
  <style>
    /* Global Styles */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f7f7f8;
      color: #343541;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    /* Header */
    .header {
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      position: relative;
    }
    .header button {
      position: absolute;
      right: 16px;
      top: 16px;
      background: transparent;
      border: none;
      color: #007aff;
      font-size: 14px;
      cursor: pointer;
    }
    /* Main Container: Zwei Spalten */
    .main-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    /* Chat Section (Links, 75%) */
    .chat-section {
      flex: 3;
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;
    }
    /* Chat Container */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 16px;
    }
    /* Message Bubbles */
    .message {
      max-width: 80%;
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.5;
      font-size: 16px;
      word-wrap: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    .message.bot {
      background-color: #fff;
      border: 1px solid #e0e0e0;
      align-self: flex-start;
    }
    .message.user {
      background-color: #007aff;
      color: #fff;
      align-self: flex-end;
    }
    /* Typing Indicator */
    .typing-indicator {
      font-style: italic;
      color: #888;
      margin: 8px 0;
      display: flex;
      align-items: center;
    }
    .typing-indicator span {
      display: inline-block;
      animation: blink 1s infinite;
      margin-left: 4px;
    }
    @keyframes blink {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }
    /* Input Area */
    .input-area {
      display: flex;
      padding: 16px;
      border-top: 1px solid #e0e0e0;
      background: #fff;
    }
    .input-area input {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-right: 8px;
      outline: none;
      transition: border-color 0.2s;
    }
    .input-area input:focus {
      border-color: #007aff;
    }
    .input-area button {
      padding: 0 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      background-color: #007aff;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .input-area button:hover {
      background-color: #005ecb;
    }
    /* Info Section (Rechts, 25%) */
    .info-section {
      flex: 1;
      border-left: 1px solid #e0e0e0;
      padding: 16px;
      overflow-y: auto;
      background-color: #fff;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      .info-section {
        border-left: none;
        border-top: 1px solid #e0e0e0;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    Dein persönlicher Assistent
    <button onclick="resetChat()">Reset</button>
  </div>
  <div class="main-container">
    <!-- Linke Spalte: Chat -->
    <div class="chat-section">
      <div class="chat-container" id="chatContainer">
        <!-- Chat-Nachrichten erscheinen hier -->
      </div>
      <div class="input-area" id="inputArea">
        <input type="text" id="userInput" placeholder="Deine Nachricht..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Absenden</button>
      </div>
    </div>
    <!-- Rechte Spalte: Info -->
    <div class="info-section">
      <h3>Infos</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin vitae justo euismod, pharetra eros ac, efficitur nibh. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Duis in volutpat lectus. Vivamus ac ante sit amet ligula sodales suscipit. Cras nec felis vel arcu fermentum dictum.</p>
    </div>
  </div>
  
  <script>
    let userName = "";
    let userId = "";
    let askedForName = true;
    let lastBotAnswer = "";
    // Der Webhook wird hier simuliert – der echte Aufruf kann integriert werden.
    const webhookUrl = "https://hook.us2.make.com/crk4yctny91n557tnx34f7tjtx9ycudp";
    let chatHistory = [];
    
    function initializeUser() {
      const storedUserId = localStorage.getItem("userId");
      if (storedUserId) {
        userId = storedUserId;
      } else {
        userId = "user-" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("userId", userId);
      }
      const storedUserName = localStorage.getItem("userName");
      if (storedUserName) {
        userName = storedUserName;
        askedForName = false;
      }
    }
    
    function saveChatHistory() {
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }
    
    function loadChatHistory() {
      const storedHistory = localStorage.getItem("chatHistory");
      if (storedHistory) {
        try {
          chatHistory = JSON.parse(storedHistory);
          chatHistory.forEach(msg => renderMessage(msg.sender, msg.text));
        } catch (error) {
          console.error("Fehler beim Laden des Chatverlaufs:", error);
          chatHistory = [];
        }
      }
    }
    
    // Formatiert Bot-Nachrichten: erkennt Headings, Absätze und einen Quellen-Block
    function formatMessage(text) {
      const parts = text.split("\n\nQuellen:\n");
      const mainText = parts[0];
      const footnoteText = parts[1] || "";
      let html = "";
      const lines = mainText.split("\n");
      lines.forEach(line => {
        const trimmed = line.trim();
        if (trimmed.startsWith("# ")) {
          html += `<h1>${trimmed.substring(2)}</h1>`;
        } else if (trimmed.startsWith("## ")) {
          html += `<h2>${trimmed.substring(3)}</h2>`;
        } else if (trimmed.startsWith("### ")) {
          html += `<h3>${trimmed.substring(4)}</h3>`;
        } else if (trimmed !== "") {
          html += `<p>${trimmed}</p>`;
        } else {
          html += `<br>`;
        }
      });
      if (footnoteText.trim()) {
        html += `<h3>Quellen</h3>`;
        const sources = footnoteText.split("\n");
        sources.forEach(source => {
          const s = source.trim();
          if (s !== "") {
            html += `<p>${s}</p>`;
          }
        });
      }
      return html;
    }
    
    function renderMessage(sender, text) {
      const container = document.getElementById("chatContainer");
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", sender);
      msgDiv.innerHTML = sender === "bot" ? formatMessage(text) : text;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }
    
    function addMessage(sender, text) {
      renderMessage(sender, text);
      chatHistory.push({ sender, text });
      saveChatHistory();
    }
    
    function handleKeyPress(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }
    
    async function sendMessage() {
      const inputEl = document.getElementById("userInput");
      const userInput = inputEl.value.trim();
      if (!userInput) return;
      
      // Wenn der Name noch abgefragt wird, wird dieser Wert als Name übernommen.
      if (askedForName && !userName) {
        userName = userInput;
        localStorage.setItem("userName", userName);
        addMessage("bot", `Hallo ${userName}, schön, dass Du hier bist und diese neue und noch im Training befindliche KI testen möchtest.`);
        showInitialOptions();
        askedForName = false;
        inputEl.value = "";
        return;
      }
      
      // Normale Chat-Nachricht (z. B. bei "Ausbildung")
      addMessage("user", userInput);
      inputEl.value = "";
      
      // Hier kann ein Webhook-Aufruf integriert werden – aktuell simulieren wir eine Antwort.
      addMessage("bot", "Danke für deine Frage. Bitte warte einen Moment...");
    }
    
    // Zeigt initial die beiden Auswahlmöglichkeiten an.
    function showInitialOptions() {
      const optionsHTML = `
        <p>Bitte wähle:</p>
        <button onclick="handleOption('prueferseminar')">Hast Du Fragen zum Prüferseminar?</button>
        <button onclick="handleOption('ausbildung')">Hast Du Fragen zu Ausbildung?</button>
      `;
      addMessage("bot", optionsHTML);
    }
    
    // Behandelt die Auswahl.
    function handleOption(option) {
      if (option === 'prueferseminar') {
        showPrueferseminarOptions();
      } else if (option === 'ausbildung') {
        addMessage("bot", "Bitte stelle jetzt deine Fragen zur Ausbildung.");
      }
    }
    
    // Zeigt für das Prüferseminar zwei klickbare Optionen an.
    function showPrueferseminarOptions() {
      const html = `
        <p>Wähle eine Option:</p>
        <button onclick="window.open('https://www.ihk-oldenburg.de/sps', '_blank')">Termine der Prüferseminare</button>
        <button onclick="window.open('https://www.ihk-oldenburg.de/prueferunterlagen', '_blank')">Prüferunterlagen</button>
      `;
      addMessage("bot", html);
    }
    
    function resetChat() {
      localStorage.removeItem("chatHistory");
      localStorage.removeItem("userName");
      chatHistory = [];
      userName = "";
      askedForName = true;
      lastBotAnswer = "";
      document.getElementById("chatContainer").innerHTML = "";
      document.getElementById("userInput").value = "";
      setTimeout(() => {
        addMessage("bot", "Hallo, darf ich dich mit deinem Vornamen ansprechen?");
      }, 500);
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      initializeUser();
      loadChatHistory();
      if (chatHistory.length === 0) {
        setTimeout(() => {
          addMessage("bot", "Hallo, darf ich dich mit deinem Vornamen ansprechen?");
          askedForName = true;
        }, 500);
      }
    });
  </script>
</body>
</html>
