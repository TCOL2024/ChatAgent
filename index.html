<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>macOS Chat Assistent</title>
  <style>
    :root {
      --primary-color: #007AFF;
      --primary-hover: #0063CC;
      --mac-window-bg: #FFFFFF;
      --mac-sidebar-bg: #F6F6F6;
      --mac-header-bg: #F6F6F6;
      --mac-border: #E5E5E5;
      --mac-text: #333333;
      --mac-text-secondary: #8A8A8A;
      --message-user-bg: #007AFF;
      --message-bot-bg: #F0F0F0;
      --shadow: 0 1px 2px rgba(0,0,0,0.1);
      --radius: 8px;
    }

    .dark-mode {
      --mac-window-bg: #2C2C2C;
      --mac-sidebar-bg: #333333;
      --mac-header-bg: #333333;
      --mac-border: #464646;
      --mac-text: #FFFFFF;
      --mac-text-secondary: #AAAAAA;
      --message-bot-bg: #3A3A3A;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
    }

    body {
      background-color: #333; /* Dunklerer Hintergrund für das "Desktop"-Gefühl */
      color: var(--mac-text);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      line-height: 1.5;
    }

    .mac-window {
      width: 1020px;
      max-width: 95%;
      background: var(--mac-window-bg);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 85vh;
      max-height: 800px;
      position: relative;
      border: 1px solid var(--mac-border);
    }

    .titlebar {
      height: 38px;
      background: var(--mac-header-bg);
      border-bottom: 1px solid var(--mac-border);
      display: flex;
      align-items: center;
      padding: 0 15px;
      user-select: none;
      -webkit-app-region: drag; /* This makes it look draggable */
    }

    .window-controls {
      display: flex;
      gap: 8px;
      margin-right: 15px;
    }

    .window-control {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      cursor: pointer;
    }

    .close {
      background-color: #FF5F57;
      border: 1px solid #E33E32;
    }

    .minimize {
      background-color: #FFBD2E;
      border: 1px solid #E2A100;
    }

    .maximize {
      background-color: #28C940;
      border: 1px solid #1AAB29;
    }

    .window-title {
      flex: 1;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: var(--mac-text);
    }

    .app-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 260px;
      background: var(--mac-sidebar-bg);
      border-right: 1px solid var(--mac-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--mac-border);
    }
    
    .new-chat-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .new-chat-btn:hover {
      background-color: var(--primary-hover);
    }
    
    .new-chat-btn-icon {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .chat-group {
      margin-bottom: 16px;
    }

    .group-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--mac-text-secondary);
      padding: 6px 16px;
      margin-bottom: 4px;
    }

    .chat-item {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      color: var(--mac-text);
      font-size: 13px;
      cursor: pointer;
      position: relative;
      border-radius: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .chat-item-content {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-item:hover {
      background-color: rgba(0,0,0,0.04);
    }
    
    .chat-item:hover .chat-item-actions {
      display: flex;
    }

    .chat-item.active {
      background-color: rgba(0,122,255,0.1);
      color: var(--primary-color);
    }
    
    .chat-item-icon {
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .chat-item-actions {
      display: none;
      position: absolute;
      right: 12px;
      align-items: center;
    }
    
    .chat-action-btn {
      background: none;
      border: none;
      color: var(--mac-text-secondary);
      padding: 4px;
      margin-left: 2px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }
    
    .chat-action-btn:hover {
      background-color: rgba(0,0,0,0.1);
      color: var(--mac-text);
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--mac-window-bg);
    }
    
    .chat-info {
      padding: 16px 20px;
      border-bottom: 1px solid var(--mac-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-info-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--mac-text);
    }
    
    .chat-info-date {
      font-size: 12px;
      color: var(--mac-text-secondary);
    }

    .chat-box {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    
    .empty-chat {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--mac-text-secondary);
      text-align: center;
      padding: 20px;
    }
    
    .empty-chat-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--primary-color);
      opacity: 0.7;
    }
    
    .empty-chat-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--mac-text);
    }
    
    .empty-chat-text {
      font-size: 14px;
      max-width: 460px;
      line-height: 1.6;
    }

    .message-container {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      max-width: 85%;
    }

    .message-container.user-container {
      margin-left: auto;
      flex-direction: row-reverse;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      color: white;
      flex-shrink: 0;
      font-size: 13px;
    }

    .avatar.bot-avatar {
      background-color: var(--primary-color);
    }

    .avatar.user-avatar {
      background-color: #6c757d;
    }

    .message {
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.5;
      animation: fadeIn 0.3s ease;
      position: relative;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .user-message {
      background-color: var(--message-user-bg);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .bot-message {
      background-color: var(--message-bot-bg);
      color: var(--mac-text);
      border-bottom-left-radius: 4px;
    }

    .input-container {
      display: flex;
      border-top: 1px solid var(--mac-border);
      padding: 15px 20px;
      background: var(--mac-window-bg);
    }

    .input-container input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--mac-border);
      border-radius: 20px;
      outline: none;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
      background-color: var(--mac-window-bg);
      color: var(--mac-text);
    }

    .input-container input:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    }

    .input-container button {
      padding: 8px 16px;
      margin-left: 10px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.1s ease;
      font-weight: 500;
      font-size: 14px;
    }

    .input-container button:hover {
      background: var(--primary-hover);
    }

    .input-container button:active {
      transform: translateY(1px);
    }

    .footnotes {
      font-size: 12px;
      color: var(--mac-text-secondary);
      margin-top: 10px;
      border-top: 1px solid var(--mac-border);
      padding-top: 10px;
    }

    .footnotes p {
      margin: 4px 0;
    }

    /* Formatierungen für die Nachrichten */
    .bot-message p {
      margin-bottom: 8px;
    }

    .bot-message p:last-child {
      margin-bottom: 0;
    }

    .bot-message ul {
      margin: 8px 0;
      padding-left: 20px;
    }

    .bot-message li {
      margin-bottom: 6px;
    }

    .bot-message strong {
      font-weight: 600;
    }

    .bot-message em {
      font-style: italic;
    }

    hr {
      border: 0;
      height: 1px;
      background-color: var(--mac-border);
      margin: 10px 0;
    }

    /* Ladeanimation */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 8px 14px;
    }

    .typing-indicator span {
      height: 8px;
      width: 8px;
      margin: 0 2px;
      background-color: var(--mac-text-secondary);
      border-radius: 50%;
      display: inline-block;
      animation: bounce 1.5s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) {
      animation-delay: 0s;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes bounce {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-4px);
      }
    }
    
    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    
    .modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-content {
      background-color: var(--mac-window-bg);
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 400px;
      padding: 24px;
      color: var(--mac-text);
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--mac-text);
    }
    
    .modal-body {
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .modal-btn-cancel {
      background-color: transparent;
      border: 1px solid var(--mac-border);
      color: var(--mac-text);
    }
    
    .modal-btn-cancel:hover {
      background-color: rgba(0,0,0,0.05);
    }
    
    .modal-btn-confirm {
      background-color: var(--primary-color);
      border: none;
      color: white;
    }
    
    .modal-btn-confirm:hover {
      background-color: var(--primary-hover);
    }
    
    .modal-btn-danger {
      background-color: #FF5F57;
      border: none;
      color: white;
    }
    
    .modal-btn-danger:hover {
      background-color: #E33E32;
    }
    
    /* Status bar */
    .status-bar {
      height: 24px;
      padding: 0 15px;
      display: flex;
      align-items: center;
      font-size: 12px;
      color: var(--mac-text-secondary);
      background-color: var(--mac-window-bg);
      border-top: 1px solid var(--mac-border);
    }

    /* Responsives Design */
    @media (max-width: 768px) {
      .mac-window {
        height: 90vh;
        width: 100%;
        max-width: 100%;
        border-radius: 0;
      }
      
      .sidebar {
        position: absolute;
        left: 0;
        top: 38px;
        bottom: 0;
        z-index: 100;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        width: 280px;
      }
      
      .sidebar.show {
        transform: translateX(0);
      }
      
      .mobile-menu-toggle {
        display: block !important;
      }
      
      .message-container {
        max-width: 90%;
      }
    }
    
    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 18px;
      color: var(--mac-text);
      margin-right: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="mac-window" id="macWindow">
    <div class="titlebar">
      <div class="window-controls">
        <div class="window-control close"></div>
        <div class="window-control minimize"></div>
        <div class="window-control maximize"></div>
      </div>
      <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
      <div class="window-title">Chat Assistent</div>
      <div style="width: 51px;"></div> <!-- Spacer for visual balance -->
    </div>
    
    <div class="app-container">
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <button class="new-chat-btn" id="newChatBtn">
            <span class="new-chat-btn-icon">+</span>
            <span>Neuer Chat</span>
          </button>
        </div>
        <div class="sidebar-content" id="sidebarContent">
          <!-- Chat-Gruppen werden hier dynamisch eingefügt -->
        </div>
      </div>
      
      <div class="main-content">
        <div class="chat-info" id="chatInfo">
          <div class="chat-info-title">Neuer Chat</div>
          <div class="chat-info-date" id="chatDate"></div>
        </div>
        
        <div class="chat-box" id="chatBox">
          <!-- Willkommensanzeige für neuen Chat -->
          <div class="empty-chat" id="emptyChat">
            <div class="empty-chat-icon">💬</div>
            <div class="empty-chat-title">Wie kann ich dir helfen?</div>
            <div class="empty-chat-text">
              Starte eine neue Unterhaltung mit dem Chat Assistenten. Deine Chats werden automatisch in der Seitenleiste gespeichert.
            </div>
          </div>
        </div>
        
        <div class="input-container">
          <input type="text" id="userInput" placeholder="Deine Nachricht..." onkeypress="handleKeyPress(event)" />
          <button onclick="sendMessage()">Senden</button>
        </div>
        
        <div class="status-bar">
          <span id="status">Bereit</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal für Chat löschen -->
  <div class="modal" id="deleteChatModal">
    <div class="modal-content">
      <div class="modal-title">Chat löschen</div>
      <div class="modal-body">
        Möchtest du diesen Chat wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" id="cancelDeleteBtn">Abbrechen</button>
        <button class="modal-btn modal-btn-danger" id="confirmDeleteBtn">Löschen</button>
      </div>
    </div>
  </div>

  <script>
    // Chat-System und Verlaufsverwaltung
    let userName = "";
    let userInitial = ""; // Speichert den ersten Buchstaben des Benutzernamens
    let allChats = []; // Speichert alle Chat-Sitzungen
    let currentChatId = null; // Aktuelle Chat-ID
    let chatNameAsked = false; // Flag, ob der Name bereits abgefragt wurde
    
    // Zeitformatierungsfunktionen
    const formatDate = (date) => {
      return new Date(date).toLocaleDateString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    };
    
    const formatTime = (date) => {
      return new Date(date).toLocaleTimeString('de-DE', {
        hour: '2-digit',
        minute: '2-digit'
      });
    };
    
    // Chat-Zeitraum bestimmen
    const getChatTimeframe = (timestamp) => {
      const now = new Date();
      const chatDate = new Date(timestamp);
      const diffDays = Math.floor((now - chatDate) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return 'Heute';
      } else if (diffDays === 1) {
        return 'Gestern';
      } else if (diffDays < 7) {
        return 'Letzte 7 Tage';
      } else if (diffDays < 30) {
        return 'Diesen Monat';
      } else {
        return 'Ältere Chats';
      }
    };
    
    // Chat-Sitzung erstellen
    const createChat = () => {
      const chatId = 'chat_' + Date.now();
      const chatTitle = `Neuer Chat`;
      const createdAt = Date.now();
      
      const newChat = {
        id: chatId,
        title: chatTitle,
        messages: [],
        createdAt: createdAt,
        updatedAt: createdAt
      };
      
      allChats.unshift(newChat); // Neuen Chat am Anfang einfügen
      currentChatId = chatId;
      
      // Neuer Chat ist aktiv, also leeren wir den Chat-Bereich
      document.getElementById('chatBox').innerHTML = '';
      document.getElementById('emptyChat').style.display = 'flex';
      document.getElementById('chatInfo').querySelector('.chat-info-title').textContent = chatTitle;
      document.getElementById('chatDate').textContent = formatDate(createdAt) + ' ' + formatTime(createdAt);
      
      chatNameAsked = false; // Namen-Abfrage zurücksetzen
      
      // Seitenleiste aktualisieren
      renderSidebar();
      
      return newChat;
    };
    
    // Nachricht zu Chat hinzufügen
    const addMessageToChat = (chatId, sender, text) => {
      const chat = allChats.find(c => c.id === chatId);
      if (!chat) return;
      
      // Nachricht zum Chat hinzufügen
      chat.messages.push({
        id: 'msg_' + Date.now(),
        sender: sender,
        text: text,
        timestamp: Date.now()
      });
      
      // Zeitstempel aktualisieren
      chat.updatedAt = Date.now();
      
      // Wenn es die erste Nachricht ist und vom Benutzer, setzen wir den Chat-Titel
      if (chat.messages.length === 1 && sender === 'user' && chat.title === 'Neuer Chat') {
        // Kürzen wenn nötig
        chat.title = text.length > 30 ? text.substring(0, 27) + '...' : text;
        document.getElementById('chatInfo').querySelector('.chat-info-title').textContent = chat.title;
      }
      
      // Seitenleiste aktualisieren
      renderSidebar();
      
      return chat;
    };
    
    // Chat löschen
    const deleteChat = (chatId) => {
      const chatIndex = allChats.findIndex(c => c.id === chatId);
      if (chatIndex === -1) return;
      
      // Chat aus der Liste entfernen
      allChats.splice(chatIndex, 1);
      
      // Wenn der aktuelle Chat gelöscht wurde, neuen Chat erstellen
      if (currentChatId === chatId) {
        if (allChats.length > 0) {
          // Wechsle zum ersten Chat in der Liste
          currentChatId = allChats[0].id;
          loadChat(currentChatId);
        } else {
          // Erstelle neuen Chat, wenn keine mehr vorhanden
          createChat();
        }
      }
      
      // Seitenleiste aktualisieren
      renderSidebar();
    };
    
    // Chat laden
    const loadChat = (chatId) => {
      const chat = allChats.find(c => c.id === chatId);
      if (!chat) return;
      
      currentChatId = chatId;
      
      // Chat-Box leeren
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '';
      
      // Chat-Info aktualisieren
      document.getElementById('chatInfo').querySelector('.chat-info-title').textContent = chat.title;
      document.getElementById('chatDate').textContent = formatDate(chat.createdAt) + ' ' + formatTime(chat.createdAt);
      
      // Wenn es keine Nachrichten gibt, zeige die Empty-Chat-Ansicht
      if (chat.messages.length === 0) {
        document.getElementById('emptyChat').style.display = 'flex';
      } else {
        document.getElementById('emptyChat').style.display = 'none';
        
        // Nachrichten rendern
        chat.messages.forEach(message => {
          if (message.sender === 'user') {
            renderUserMessage(message.text);
          } else {
            renderBotMessage(message.text);
          }
        });
      }
      
      // Seitenleiste aktualisieren (um aktiven Chat zu markieren)
      renderSidebar();
    };
    
    // Sidebar rendern
    const renderSidebar = () => {
      const sidebarContent = document.getElementById('sidebarContent');
      sidebarContent.innerHTML = '';
      
      // Gruppiere Chats nach Zeitraum
      const groupedChats = {};
      
      allChats.forEach(chat => {
        const timeframe = getChatTimeframe(chat.createdAt);
        if (!groupedChats[timeframe]) {
          groupedChats[timeframe] = [];
        }
        groupedChats[timeframe].push(chat);
      });
      
      // Sortierung der Zeiträume
      const timeframeOrder = ['Heute', 'Gestern', 'Letzte 7 Tage', 'Diesen Monat', 'Ältere Chats'];
      
      // Für jeden Zeitraum eine Gruppe erstellen
      timeframeOrder.forEach(timeframe => {
        if (groupedChats[timeframe] && groupedChats[timeframe].length > 0) {
          // Gruppe erstellen
          const groupElement = document.createElement('div');
          groupElement.classList.add('chat-group');
          
          // Titel erstellen
          const titleElement = document.createElement('div');
          titleElement.classList.add('group-title');
          titleElement.textContent = timeframe;
          groupElement.appendChild(titleElement);
          
          // Chats in dieser Gruppe hinzufügen
          groupedChats[timeframe].forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.classList.add('chat-item');
            if (chat.id === currentChatId) {
              chatItem.classList.add('active');
            }
            
            chatItem.innerHTML = `
              <div class="chat-item-icon">💬</div>
              <div class="chat-item-content">${chat.title}</div>
              <div class="chat-item-actions">
                <button class="chat-action-btn delete-chat-btn" data-id="${chat.id}">🗑️</button>
              </div>
            `;
            
            // Event-Listener für Chat-Klick
            chatItem.addEventListener('click', (e) => {
              // Nicht ausführen, wenn auf den Löschen-Button geklickt wurde
              if (e.target.classList.contains('delete-chat-btn') || 
                  e.target.closest('.delete-chat-btn')) {
                return;
              }
              
              loadChat(chat.id);
            });
            
            groupElement.appendChild(chatItem);
          });
          
          sidebarContent.appendChild(groupElement);
        }
      });
      
      // Event-Listener für Löschen-Buttons
      document.querySelectorAll('.delete-chat-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation(); // Verhindert Bubble-Up zum Elternelement
          
          const chatId = button.getAttribute('data-id');
          showDeleteChatModal(chatId);
        });
      });
    };
    
    // Chat-Lösch-Modal anzeigen
    const showDeleteChatModal = (chatId) => {
      const modal = document.getElementById('deleteChatModal');
      modal.classList.add('active');
      
      // Event-Listener für Bestätigungs-Button
      const confirmBtn = document.getElementById('confirmDeleteBtn');
      confirmBtn.onclick = () => {
        deleteChat(chatId);
        modal.classList.remove('active');
      };
      
      // Event-Listener für Abbrechen-Button
      const cancelBtn = document.getElementById('cancelDeleteBtn');
      cancelBtn.onclick = () => {
        modal.classList.remove('active');
      };
    };
    
    // User-Nachricht rendern
    const renderUserMessage = (text) => {
      const chatBox = document.getElementById('chatBox');
      document.getElementById('emptyChat').style.display = 'none';
      
      const messageContainer = document.createElement('div');
      messageContainer.classList.add('message-container', 'user-container');
      
      const avatar = document.createElement('div');
      avatar.classList.add('avatar', 'user-avatar');
      avatar.textContent = userInitial || "D";
      
      const message = document.createElement('div');
      message.classList.add('message', 'user-message');
      message.textContent = text;
      
      messageContainer.appendChild(avatar);
      messageContainer.appendChild(message);
      
      chatBox.appendChild(messageContainer);
      chatBox.scrollTop = chatBox.scrollHeight;
    };
    
    // Bot-Nachricht rendern
    const renderBotMessage = (text) => {
      const chatBox = document.getElementById('chatBox');
      document.getElementById('emptyChat').style.display = 'none';
      
      const messageContainer = document.createElement('div');
      messageContainer.classList.add('message-container');
      
      const avatar = document.createElement('div');
      avatar.classList.add('avatar', 'bot-avatar');
      avatar.textContent = "B";
      
      const message = document.createElement('div');
      message.classList.add('message', 'bot-message');
      message.innerHTML = formatMessage(text);
      
      messageContainer.appendChild(avatar);
      messageContainer.appendChild(message);
      
      chatBox.appendChild(messageContainer);
      chatBox.scrollTop = chatBox.scrollHeight;
    };
    
    /**
     * Wandelt den Text in formatiertes HTML um.
     * Teilt den Haupttext und die Fußnoten (Quellen) anhand des Separators "\n\nQuellen:\n".
     * Ersetzt einfache Markdown-Syntax (* und **) und wandelt Zeilen, die mit "* " beginnen, in Listen um.
     */
    function formatMessage(text) {
      const parts = text.split("\n\nQuellen:\n");
      const mainText = parts[0];
      const footnoteText = parts[1] ? parts[1] : "";
      const lines = mainText.split("\n");

      let html = "";
      let inList = false;

      for (let line of lines) {
        let trimmedLine = line.trim();
        trimmedLine = trimmedLine
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>");

        if (trimmedLine.startsWith("* ")) {
          if (!inList) {
            inList = true;
            html += "<ul>";
          }
          let bulletPoint = trimmedLine.substring(2);
          html += `<li>${bulletPoint}</li>`;
        } else {
          if (inList) {
            inList = false;
            html += "</ul>";
          }
          if (trimmedLine !== "") {
            html += `<p>${trimmedLine}</p>`;
          } else {
            html += "<br>";
          }
        }
      }
      if (inList) {
        html += "</ul>";
      }

      if (footnoteText.trim()) {
        let footnotes = footnoteText.split("\n").filter(fn => fn.trim() !== "");
        if (footnotes.length > 0) {
          html += "<hr><div class='footnotes'>";
          footnotes.forEach((fn, index) => {
            html += `<p>Quelle ${index + 1}: ${fn.trim()}</p>`;
          });
          html += "</div>";
        }
      }
      return html;
    }
    
    // Dark Mode-Erkennung und -Umschaltung
    function checkDarkMode() {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.getElementById('macWindow').classList.add('dark-mode');
      }
    }
    
    // Dark Mode-Event-Listener
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (event.matches) {
          document.getElementById('macWindow').classList.add('dark-mode');
        } else {
          document.getElementById('macWindow').classList.remove('dark-mode');
        }
      });
    }
    
    function handleKeyPress(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }
    
    function sendMessage() {
      const userInput = document.getElementById("userInput").value.trim();
      if (!userInput) return;
      
      document.getElementById("userInput").value = "";
      document.getElementById("userInput").focus();
      
      // Stelle sicher, dass wir einen aktuellen Chat haben
      if (!currentChatId) {
        createChat();
      }
      
      // Füge die Nachricht zum UI und zum Chat-Objekt hinzu
      renderUserMessage(userInput);
      addMessageToChat(currentChatId, 'user', userInput);
      
      // Status aktualisieren
      document.getElementById("status").textContent = "Nachricht gesendet...";
      
      // Wenn wir noch keinen Namen haben und der Name noch nicht abgefragt wurde
      if (!userName && !chatNameAsked) {
        chatNameAsked = true;
        userName = userInput;
        userInitial = userName.charAt(0).toUpperCase();
        
        let greeting = `Hallo ${userName}, nun stelle mir bitte Deine Frage.`;
        setTimeout(() => {
          document.getElementById("status").textContent = "Bereit";
          renderBotMessage(greeting);
          addMessageToChat(currentChatId, 'bot', greeting);
        }, 800);
        return;
      }
      
      // Ladeanimation hinzufügen
      const chatBox = document.getElementById("chatBox");
      const messageContainer = document.createElement("div");
      messageContainer.classList.add("message-container");
      messageContainer.id = "loading-indicator";

      const avatar = document.createElement("div");
      avatar.classList.add("avatar", "bot-avatar");
      avatar.textContent = "B";

      const loadingIndicator = document.createElement("div");
      loadingIndicator.classList.add("message", "bot-message", "typing-indicator");
      loadingIndicator.innerHTML = "<span></span><span></span><span></span>";

      messageContainer.appendChild(avatar);
      messageContainer.appendChild(loadingIndicator);
      chatBox.appendChild(messageContainer);
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // Beispielhafter Webhook-Aufruf; passe die URL bei Bedarf an
      const webhookUrl = "https://hook.us2.make.com/28v27trtikh287mce0f63qb39a7t65pn";
      fetch(`${webhookUrl}?name=${encodeURIComponent(userName)}&message=${encodeURIComponent(userInput)}&status=ok`)
        .then(response => response.text())
        .then(data => {
          // Ladeanimation entfernen
          const loadingIndicator = document.getElementById("loading-indicator");
          if (loadingIndicator) {
            chatBox.removeChild(loadingIndicator);
          }
          document.getElementById("status").textContent = "Antwort erhalten";
          renderBotMessage(data);
          addMessageToChat(currentChatId, 'bot', data);
          
          // Nach kurzer Zeit Status zurücksetzen
          setTimeout(() => {
            document.getElementById("status").textContent = "Bereit";
          }, 3000);
        })
        .catch(error => {
          // Ladeanimation entfernen
          const loadingIndicator = document.getElementById("loading-indicator");
          if (loadingIndicator) {
            chatBox.removeChild(loadingIndicator);
          }
          document.getElementById("status").textContent = "Fehler aufgetreten";
          
          const errorMessage = "Entschuldigung, es gab ein Problem bei der Verarbeitung deiner Anfrage. Bitte versuche es erneut.";
          renderBotMessage(errorMessage);
          addMessageToChat(currentChatId, 'bot', errorMessage);
        });
    }
    
    // Event-Listener
    document.addEventListener("DOMContentLoaded", function () {
      checkDarkMode();
      
      // Ersten Chat erstellen
      createChat();
      
      // Event-Listener für "Neuer Chat"-Button
      document.getElementById('newChatBtn').addEventListener('click', () => {
        createChat();
      });
      
      // Mobile-Menü-Toggle
      document.getElementById('mobileMenuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('show');
      });
      
      // Begrüßungsnachricht nach kurzer Zeit anzeigen
      setTimeout(() => {
        let welcomeMessage = "Schön, dass Du diesen Bot nutzt. Ich möchte Dich gerne persönlich ansprechen. Verrate mir bitte Deinen Namen.";
        renderBotMessage(welcomeMessage);
        addMessageToChat(currentChatId, 'bot', welcomeMessage);
      }, 800);
    });
  </script>
</body>
</html>
