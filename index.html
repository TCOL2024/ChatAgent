<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dein persönlicher Assistent</title>
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .chat-container {
      width: 800px;
      max-width: 90%;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      font-size: 24px;
      font-weight: bold;
      padding: 20px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      background: #fff;
    }
    .chat-box {
      padding: 20px;
      height: 400px;
      overflow-y: auto;
      background-color: #fff;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      padding: 12px;
      border-radius: 8px;
      max-width: 70%;
      font-size: 14px;
      line-height: 1.5;
    }
    .user-message {
      align-self: flex-end;
      background-color: #003DA5;
      color: #fff;
    }
    .bot-message {
      align-self: flex-start;
      background-color: #f0f2f5;
      color: #333;
    }
    .prompt-button {
      background: none;
      border: 1px solid #003DA5;
      color: #003DA5;
      border-radius: 20px;
      padding: 8px 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    .prompt-button:hover {
      background: #003DA5;
      color: #fff;
    }
    .input-container {
      display: flex;
      border-top: 1px solid #ddd;
      padding: 12px;
      background: #fff;
    }
    .input-container input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      outline: none;
      font-size: 14px;
    }
    .input-container button {
      padding: 12px 20px;
      margin-left: 10px;
      background: #003DA5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .input-container button:hover {
      background: #002b7a;
    }
    .footnotes {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }
    .footnotes p {
      margin: 4px 0;
    }
    /* Container für Prompt-Buttons */
    .prompt-container {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .prompt-category {
      margin: 0;
      font-weight: bold;
      font-size: 15px;
      width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">Willkommen im Chat</div>
    <div class="chat-box" id="chatBox"></div>
    <div class="input-container">
      <input type="text" id="userInput" placeholder="Ihre Nachricht" onkeypress="handleKeyPress(event)" />
      <button onclick="sendMessage()">Absenden</button>
    </div>
  </div>

  <script>
    let userName = "";

    // Globale Definition der Prompt-Gruppen
    const promptGroups = {
      "Ausbildungsfragen": [
        "Welche Voraussetzungen muss ich für eine Ausbildung in [Beruf] erfüllen?",
        "Wie bewerbe ich mich für eine Ausbildungsstelle bei [Unternehmen]?",
        "Welche Ausbildungsinhalte erwarten mich in der Ausbildung zum/zur [Beruf]?",
        "Wie lange dauert die Ausbildung zum/zur [Beruf]?",
        "Welche Weiterbildungsmöglichkeiten habe ich nach der Ausbildung?"
      ],
      "Eignung": [
        "Welche Fähigkeiten und Interessen sollte ich für den Beruf [Beruf] mitbringen?",
        "Wie finde ich heraus, ob ich für eine Ausbildung in [Beruf] geeignet bin?",
        "Welche Tests oder Prüfungen muss ich bestehen, um meine Eignung nachzuweisen?",
        "Gibt es spezielle Programme oder Kurse zur Vorbereitung auf die Ausbildung in [Beruf]?"
      ],
      "Jugendarbeitsschutzgesetz": [
        "Welche Arbeitszeiten gelten für minderjährige Auszubildende?",
        "Welche Pausenregelungen gibt es für Jugendliche in der Ausbildung?",
        "Welche Tätigkeiten sind für minderjährige Auszubildende verboten?",
        "Wie viele Urlaubstage stehen mir als minderjähriger Auszubildender zu?"
      ],
      "Arbeitszeit": [
        "Wie viele Stunden darf ich als Auszubildender pro Woche arbeiten?",
        "Welche Regelungen gibt es für Überstunden in der Ausbildung?",
        "Wie werden meine Arbeitszeiten dokumentiert?",
        "Was passiert, wenn ich meine Arbeitszeit überschreite?"
      ],
      "Urlaub": [
        "Wie viele Urlaubstage stehen mir während meiner Ausbildung zu?",
        "Wie beantrage ich Urlaub in meiner Ausbildung?",
        "Kann ich meinen Urlaub während der Berufsschulzeit nehmen?",
        "Was passiert mit meinem Resturlaub, wenn ich die Ausbildung beende?"
      ],
      "Vertrag": [
        "Welche Inhalte muss mein Ausbildungsvertrag enthalten?",
        "Kann ich meinen Ausbildungsvertrag vorzeitig kündigen?",
        "Was passiert, wenn mein Ausbildungsvertrag geändert werden muss?",
        "Welche Rechte und Pflichten habe ich als Auszubildender laut Vertrag?"
      ]
    };

    document.addEventListener("DOMContentLoaded", function () {
      setTimeout(() => {
        let welcomeMessage = "Schön, dass Du diesen Bot nutzt. Ich möchte Dich gerne persönlich ansprechen. Verrate mir bitte Deinen Namen.";
        addMessage("bot", welcomeMessage);
      }, 500);
    });

    function handleKeyPress(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }

    function usePrompt(promptText) {
      document.getElementById("userInput").value = promptText;
      sendMessage();
    }

    /**
     * Ermittelt, welche Prompt-Gruppen basierend auf Schlüsselwörtern in der Bot-Antwort relevant sind.
     */
    function getRelevantPromptGroups(responseText) {
      let relevant = {};
      const textLower = responseText.toLowerCase();
      
      if (textLower.includes("ausbildung")) {
        relevant["Ausbildungsfragen"] = promptGroups["Ausbildungsfragen"];
      }
      if (textLower.includes("eignung") || textLower.includes("fähigkeit") || textLower.includes("interesse") || textLower.includes("test") || textLower.includes("prüfung")) {
        relevant["Eignung"] = promptGroups["Eignung"];
      }
      if (textLower.includes("jugendarbeitsschutzgesetz") || textLower.includes("minderjährig") || textLower.includes("jugend")) {
        relevant["Jugendarbeitsschutzgesetz"] = promptGroups["Jugendarbeitsschutzgesetz"];
      }
      if (textLower.includes("arbeitszeit") || textLower.includes("stunden") || textLower.includes("überstunden")) {
        relevant["Arbeitszeit"] = promptGroups["Arbeitszeit"];
      }
      if (textLower.includes("urlaub")) {
        relevant["Urlaub"] = promptGroups["Urlaub"];
      }
      if (textLower.includes("vertrag") || textLower.includes("kündigen") || textLower.includes("inhalt")) {
        relevant["Vertrag"] = promptGroups["Vertrag"];
      }
      return relevant;
    }

    /**
     * Aktualisiert die Anzeige der Prompt-Vorschläge dynamisch, basierend auf der Bot-Antwort.
     * Werden keine relevanten Kategorien gefunden, werden keine Prompts angezeigt.
     */
    function updateDynamicPrompts(responseText) {
      // Entferne existierende Prompt-Container, falls vorhanden
      let existingContainer = document.getElementById("dynamicPromptContainer");
      if (existingContainer) {
        existingContainer.remove();
      }

      let relevantPromptGroups = getRelevantPromptGroups(responseText);
      // Nur anzeigen, wenn mindestens eine relevante Kategorie gefunden wurde
      if (Object.keys(relevantPromptGroups).length === 0) {
        return;
      }

      const chatBox = document.getElementById("chatBox");
      const container = document.createElement("div");
      container.classList.add("prompt-container");
      container.id = "dynamicPromptContainer";

      for (let category in relevantPromptGroups) {
        const heading = document.createElement("p");
        heading.classList.add("prompt-category");
        heading.textContent = category;
        container.appendChild(heading);

        relevantPromptGroups[category].forEach(prompt => {
          const button = document.createElement("button");
          button.classList.add("prompt-button");
          button.textContent = prompt;
          button.onclick = () => usePrompt(prompt);
          container.appendChild(button);
        });
      }
      chatBox.appendChild(container);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const userInput = document.getElementById("userInput").value.trim();
      if (!userInput) return;

      addMessage("user", userInput);
      document.getElementById("userInput").value = "";

      // Namenseingabe
      if (!userName) {
        userName = userInput;
        let greeting = `Hallo ${userName}, nun stelle mir bitte Deine Frage.`;
        setTimeout(() => {
          addMessage("bot", greeting);
          // Keine Prompts direkt nach der Namenseingabe anzeigen.
        }, 500);
        return;
      }

      const webhookUrl = "https://hook.us2.make.com/28v27trtikh287mce0f63qb39a7t65pn";
      const response = await fetch(`${webhookUrl}?name=${encodeURIComponent(userName)}&message=${encodeURIComponent(userInput)}&status=ok`);
      const data = await response.text();
      addMessage("bot", data);
      // Aktualisiere dynamisch die Prompts basierend auf der Antwort
      updateDynamicPrompts(data);
    }

    /**
     * Wandelt den Text in formatiertes HTML um.
     * Teilt dabei den Haupttext und die Fußnoten (Quellen) anhand des Separators "\n\nQuellen:\n".
     * Ersetzt einfache Markdown-Syntax (* und **) und wandelt Zeilen, die mit "* " beginnen, in Listen um.
     */
    function formatMessage(text) {
      const parts = text.split("\n\nQuellen:\n");
      const mainText = parts[0];
      const footnoteText = parts[1] ? parts[1] : "";
      const lines = mainText.split("\n");

      let html = "";
      let inList = false;

      for (let line of lines) {
        let trimmedLine = line.trim();
        trimmedLine = trimmedLine
          .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
          .replace(/\*(.*?)\*/g, "<em>$1</em>");

        if (trimmedLine.startsWith("* ")) {
          if (!inList) {
            inList = true;
            html += "<ul>";
          }
          let bulletPoint = trimmedLine.substring(2);
          html += `<li>${bulletPoint}</li>`;
        } else {
          if (inList) {
            inList = false;
            html += "</ul>";
          }
          if (trimmedLine !== "") {
            html += `<p>${trimmedLine}</p>`;
          } else {
            html += "<br>";
          }
        }
      }
      if (inList) {
        html += "</ul>";
      }

      if (footnoteText.trim()) {
        let footnotes = footnoteText.split("\n").filter(fn => fn.trim() !== "");
        if (footnotes.length > 0) {
          html += "<hr><div class='footnotes'>";
          footnotes.forEach((fn, index) => {
            html += `<p>Quelle ${index + 1} (${fn.trim()})</p>`;
          });
          html += "</div>";
        }
      }

      return html;
    }

    function addMessage(sender, text) {
      const chatBox = document.getElementById("chatBox");
      const message = document.createElement("div");
      message.classList.add("message", sender === "user" ? "user-message" : "bot-message");

      if (sender === "bot") {
        message.innerHTML = formatMessage(text);
      } else {
        message.textContent = text;
      }

      chatBox.appendChild(message);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
